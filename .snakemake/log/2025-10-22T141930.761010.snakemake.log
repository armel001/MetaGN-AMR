Building DAG of jobs...
Using shell: /usr/bin/bash
Provided cores: 22
Rules claiming more threads will be scaled down.
Job stats:
job                  count
-----------------  -------
abricate                16
all                      1
build_dag                1
flye_assembly           16
host_depletion          16
merge_rgi_results        1
multiqc_nanoplot         1
nanoplot                 5
plot_ARGs               16
plot_ARGs_all            1
plot_ARGs_all_R          1
plot_ARGs_by_gene       16
porechop                 1
rgi                     16
total                  108

Select jobs to execute...

[Wed Oct 22 14:19:33 2025]
rule host_depletion:
    input: results/HI16B/trimmed.fastq.gz, resources/references/GRCh38_no_alt.mmi
    output: results/HI16B/clean/HI16B_noh.fq.gz
    jobid: 75
    reason: Forced execution
    wildcards: sample=HI16B
    threads: 8
    resources: tmpdir=/tmp

Activating conda environment: .snakemake/conda/9a23c77602d9d35c4fdf433a71fcdfe1_

[Wed Oct 22 14:19:33 2025]
rule nanoplot:
    input: resources/reads/HI05A.fastq.gz
    output: results/HI05A/qc/HI05A_Nanoplot
    log: results/HI05A/qc/HI05A_Nanoplot/nanoplot.log
    jobid: 9
    reason: Code has changed since last execution
    wildcards: sample=HI05A
    threads: 6
    resources: tmpdir=/tmp

Activating conda environment: .snakemake/conda/de891c6cc03ba77d6d59f6373b0f834e_

[Wed Oct 22 14:19:33 2025]
rule host_depletion:
    input: results/CMC_MTM/trimmed.fastq.gz, resources/references/GRCh38_no_alt.mmi
    output: results/CMC_MTM/clean/CMC_MTM_noh.fq.gz
    jobid: 27
    reason: Forced execution
    wildcards: sample=CMC_MTM
    threads: 8
    resources: tmpdir=/tmp

Activating conda environment: .snakemake/conda/9a23c77602d9d35c4fdf433a71fcdfe1_
Terminating processes on user request, this might take some time.
[Wed Oct 22 14:19:55 2025]
Error in rule nanoplot:
    jobid: 9
    input: resources/reads/HI05A.fastq.gz
    output: results/HI05A/qc/HI05A_Nanoplot
    log: results/HI05A/qc/HI05A_Nanoplot/nanoplot.log (check log file(s) for error details)
    conda-env: /data/armel/git/MetagenAMR-main/.snakemake/conda/de891c6cc03ba77d6d59f6373b0f834e_
    shell:
        
        set -euo pipefail

        outdir="results/HI05A/qc/HI05A_Nanoplot"
        fq="resources/reads/HI05A.fastq.gz"
        logf="results/HI05A/qc/HI05A_Nanoplot/nanoplot.log"

        rm -rf "$outdir"
        mkdir -p "$outdir/tmp" "$outdir/.mplconfig"

        export TMPDIR="$outdir/tmp"
        export MPLBACKEND=Agg
        export MPLCONFIGDIR="$outdir/.mplconfig"

        # Exécution + redirection vers le log (pas d'option --logfile)
        set +e
        NanoPlot \
          --fastq "$fq" \
          -o "$outdir" \
          --threads 6 \
          --huge \
          -f png \
          --verbose \
        > "$logf" 2>&1
        rc=$?
        set -e

        # Fallback: garder le pipeline vivant si NanoPlot échoue
        if [ $rc -ne 0 ]; then
            echo "[nanoplot] exit code $rc — generating placeholder" | tee -a "$logf"
            cat > "$outdir/index.html" <<HTML
<!doctype html><meta charset="utf-8">
<h3>NanoPlot — HI05A</h3>
<p>Execution failed; keeping pipeline alive with a placeholder.</p>
<pre>
$(tail -n 200 "$logf" || true)
</pre>
HTML
        fi
        
        (one of the commands exited with non-zero exit code; note that snakemake uses bash strict mode!)

Cancelling snakemake on user request.
